# MASt3R-SLAM Output Guide

**Date:** December 2, 2025
**Version:** 1.0

This document describes the output files generated by MASt3R-SLAM and their formats.

---

## Output Files

When running MASt3R-SLAM, the following files are generated in the `results/` directory:

### 1. PLY Point Cloud File
**Format:** Binary PLY (Stanford Polygon File Format)
**Extension:** `.ply`
**Location:** `results/<sequence_name>/<sequence_name>.ply`

**Structure:**
```
ply
format binary_little_endian 1.0
element vertex <N>
property float x
property float y
property float z
property uchar red
property uchar green
property uchar blue
end_header
<binary vertex data>
```

**Data Content:**
- **Vertices:** 3D points from the reconstructed scene
- **Colors:** RGB color values (0-255) from the original images
- **Coordinate System:** World coordinates (transformed from camera coordinates)
- **Filtering:** Only points above confidence threshold are included

**Expected Characteristics:**
- File size: Varies based on scene complexity (typically 10MB - 500MB)
- Number of points: Depends on number of keyframes and confidence threshold
- Point density: Dense reconstruction from all keyframes
- Color accuracy: Directly from RGB images (no interpolation)

**Viewing:**
Compatible with:
- **MeshLab** - Open source mesh viewer
- **CloudCompare** - Point cloud processing software
- **Open3D** - Python library for 3D data
- **Blender** - 3D creation suite (import as point cloud)
- **TouchDesigner** - Real-time graphics (via import SOP)

### 2. Trajectory File
**Format:** TUM RGB-D format (text file)
**Extension:** `.txt`
**Location:** `results/<sequence_name>/<sequence_name>.txt`

**Structure:**
```
# timestamp tx ty tz qx qy qz qw
1305031102.175304 1.234 0.567 0.891 0.012 -0.034 0.056 0.998
1305031102.211214 1.245 0.571 0.895 0.013 -0.033 0.057 0.998
...
```

**Columns:**
1. **timestamp** - Frame timestamp (seconds)
2. **tx, ty, tz** - Camera position (meters)
3. **qx, qy, qz, qw** - Camera orientation (quaternion)

**Coordinate System:**
- World frame (fixed reference)
- Right-handed coordinate system
- Quaternions in Hamilton convention

**Usage:**
- **Evaluation:** Compare against ground truth using evo toolkit
- **Visualization:** Plot camera trajectory in 3D
- **Analysis:** Extract camera poses for further processing

---

## Running SLAM to Generate Output

### Prerequisites
- Windows build verified (all tests passing)
- TUM dataset downloaded (or other supported dataset)
- Virtual environment activated

### Method 1: Windows Command Prompt (Recommended)

**Reason:** Avoids MINGW64 environment issues that can cause segmentation faults.

**Steps:**
```cmd
REM 1. Open Windows Command Prompt (cmd.exe)
cd C:\Users\5090\MASt3R-SLAM-WINBUILD

REM 2. Activate virtual environment
.\venv\Scripts\activate.bat

REM 3. Run SLAM on TUM dataset (no visualization)
python main.py --dataset datasets\tum\rgbd_dataset_freiburg1_xyz --config config\base.yaml --no-viz --save-as test_run

REM 4. Check output
dir results\test_run\
```

**Expected Output:**
```
results\test_run\
├── rgbd_dataset_freiburg1_xyz.ply   (~20-50 MB point cloud)
└── rgbd_dataset_freiburg1_xyz.txt   (~50 KB trajectory file)
```

**Processing Time:**
- **RTX 5090:** ~2-5 minutes for freiburg1_xyz (798 frames)
- **Initialization:** ~5-10 seconds
- **Per-frame processing:** ~200-300ms average

### Method 2: PowerShell

**Steps:**
```powershell
# 1. Open PowerShell
cd C:\Users\5090\MASt3R-SLAM-WINBUILD

# 2. Activate virtual environment
.\venv\Scripts\Activate.ps1

# 3. Run SLAM
python main.py --dataset datasets\tum\rgbd_dataset_freiburg1_xyz --config config\base.yaml --no-viz --save-as test_run
```

### Method 3: Batch Script

A convenience batch script is provided:

**File:** `run_slam_test.bat`

**Usage:**
```cmd
REM Double-click run_slam_test.bat or run from cmd:
run_slam_test.bat
```

**What it does:**
1. Activates virtual environment
2. Checks dataset exists
3. Runs SLAM with default settings
4. Saves results to `results\test_run\`

---

## MINGW64 / Git Bash Issues

**Problem:** Running SLAM from Git Bash/MINGW64 environment causes segmentation faults.

**Root Cause:**
- CUDA/PyTorch interaction with MINGW64 runtime
- DLL loading differences between MINGW64 and native Windows
- Multiprocessing incompatibility

**Symptoms:**
- `Segmentation fault` error when running `main.py`
- No output generated
- Immediate crash after initialization

**Solution:**
✅ **Use Windows Command Prompt or PowerShell instead**

**Why This Works:**
- Native Windows environment
- Proper CUDA DLL loading
- Compatible with PyTorch Windows builds
- Stable multiprocessing support

**Note:** All other operations (testing, imports, simple scripts) work fine in MINGW64. Only the full SLAM pipeline requires native Windows shells.

---

## Verifying PLY Output

Once you have generated a PLY file, you can verify it:

### Method 1: Python Script Inspection

```python
# inspect_ply.py
from plyfile import PlyData
import numpy as np

ply_file = "results/test_run/rgbd_dataset_freiburg1_xyz.ply"
ply_data = PlyData.read(ply_file)

vertex = ply_data['vertex']
print(f"Number of points: {len(vertex)}")
print(f"Properties: {vertex.data.dtype.names}")
print(f"X range: [{vertex['x'].min():.3f}, {vertex['x'].max():.3f}]")
print(f"Y range: [{vertex['y'].min():.3f}, {vertex['y'].max():.3f}]")
print(f"Z range: [{vertex['z'].min():.3f}, {vertex['z'].max():.3f}]")
print(f"Color range: R[{vertex['red'].min()}, {vertex['red'].max()}]")
print(f"             G[{vertex['green'].min()}, {vertex['green'].max()}]")
print(f"             B[{vertex['blue'].min()}, {vertex['blue'].max()}]")
```

### Method 2: MeshLab Inspection

1. Download MeshLab: https://www.meshlab.net/#download
2. Open PLY file: `File > Import Mesh > <your_file>.ply`
3. Check statistics: `Filters > Quality Measures and Computations > Compute Geometric Measures`

**Expected Results for freiburg1_xyz:**
- **Points:** ~50,000 - 200,000 (depends on confidence threshold)
- **Bounding Box:** ~2-3 meters in each dimension
- **Colors:** RGB values from 0-255
- **Density:** Dense coverage along camera trajectory

### Method 3: Open3D Visualization

```python
# visualize_ply.py
import open3d as o3d

ply_file = "results/test_run/rgbd_dataset_freiburg1_xyz.ply"
pcd = o3d.io.read_point_cloud(ply_file)

print(f"Point cloud has {len(pcd.points)} points")
print(f"Point cloud has colors: {pcd.has_colors()}")

# Visualize
o3d.visualization.draw_geometries([pcd],
                                  window_name="MASt3R-SLAM Output",
                                  width=1920, height=1080)
```

---

## Quality Checks

### Good PLY File Indicators:
✅ File size > 1 MB (for typical datasets)
✅ 10,000+ points (depends on sequence length)
✅ Colors present (RGB values)
✅ No NaN or infinite values
✅ Reasonable spatial extent (< 100m typically)
✅ Dense coverage along trajectory

### Bad PLY File Indicators:
❌ File size < 100 KB
❌ Very few points (< 1000)
❌ Missing colors
❌ All points at origin (0,0,0)
❌ Unrealistic scale (points kilometers apart)
❌ File format errors when opening

---

## Troubleshooting

### Issue: No PLY file generated
**Possible Causes:**
- SLAM crashed before completion
- Segmentation fault (use Windows cmd/PowerShell)
- Write permissions issue in results directory
- Dataset path incorrect

**Solutions:**
1. Check terminal output for errors
2. Run from Windows Command Prompt instead of Git Bash
3. Verify dataset path: `datasets\tum\rgbd_dataset_freiburg1_xyz`
4. Check `results/` directory exists and is writable

### Issue: PLY file is very small (< 1 MB)
**Possible Causes:**
- High confidence threshold filtering out most points
- Very short sequence processed
- SLAM failed to track (lost tracking)

**Solutions:**
1. Lower confidence threshold in config
2. Check trajectory file - should have many poses
3. Review SLAM terminal output for tracking failures

### Issue: PLY file has no colors
**Possible Causes:**
- Image loading failure
- Color conversion error
- Dataset RGB images missing

**Solutions:**
1. Verify RGB images exist in dataset
2. Check image paths in dataset
3. Review SLAM initialization messages

### Issue: Segmentation fault when running SLAM
**Cause:** Running from MINGW64/Git Bash environment

**Solution:**
✅ **Use Windows Command Prompt or PowerShell**

See "MINGW64 / Git Bash Issues" section above.

---

## Expected Output Examples

### Small Dataset (freiburg1_xyz - 798 frames)
```
results/test_run/
├── rgbd_dataset_freiburg1_xyz.ply    (~30 MB, ~100K points)
└── rgbd_dataset_freiburg1_xyz.txt    (~50 KB, ~200 poses)
```

### Medium Dataset (freiburg2_desk - 2,800 frames)
```
results/test_run/
├── rgbd_dataset_freiburg2_desk.ply   (~120 MB, ~400K points)
└── rgbd_dataset_freiburg2_desk.txt   (~180 KB, ~700 poses)
```

### Large Dataset (freiburg3_long - 5,000+ frames)
```
results/test_run/
├── rgbd_dataset_freiburg3_long.ply   (~300 MB, ~1M points)
└── rgbd_dataset_freiburg3_long.txt   (~320 KB, ~1500 poses)
```

---

## Configuration Options Affecting Output

### Confidence Threshold
**Parameter:** `last_msg.C_conf_threshold` (default: varies by config)

**Effect on PLY:**
- **Higher threshold** → Fewer points, higher quality, smaller file
- **Lower threshold** → More points, noisier, larger file

**Location:** Configured in SLAM code, not directly in config file

### Image Downsampling
**Parameter:** `img_downsample` in config file

**Effect on PLY:**
- **Higher downsampling (e.g., 2)** → Fewer points per frame, faster processing
- **No downsampling (1)** → More points per frame, slower processing

**Recommendation for RTX 5090:** Use `img_downsample: 1` (no downsampling)

### Keyframe Selection
**Parameter:** Determined by SLAM frontend

**Effect on PLY:**
- More keyframes → Denser reconstruction
- Fewer keyframes → Sparser but faster

---

## Next Steps After Generating PLY

### 1. Visualization
- Load in MeshLab or CloudCompare
- Inspect point density and coverage
- Check for holes or missing regions

### 2. Evaluation
```bash
# Compare trajectory against ground truth
evo_ape tum groundtruth.txt results/test_run/rgbd_dataset_freiburg1_xyz.txt --plot --save_plot results/ape_plot.pdf
```

### 3. Post-Processing
- **Downsampling:** Reduce point count for faster viewing
- **Filtering:** Remove statistical outliers
- **Meshing:** Convert point cloud to mesh (Poisson reconstruction)
- **Export:** Convert to other formats (PCD, XYZ, OBJ)

### 4. Integration
- **TouchDesigner:** Import via File In SOP
- **Unreal Engine:** Import as static point cloud
- **Unity:** Import with point cloud rendering plugin
- **Blender:** Import for visualization and rendering

---

## Summary

✅ **PLY Format:** Binary, colored point cloud (x,y,z,r,g,b)
✅ **Generation:** Run SLAM from Windows cmd/PowerShell
✅ **Verification:** Open in MeshLab, CloudCompare, or Python
✅ **Quality:** Check file size, point count, colors, spatial extent
✅ **Troubleshooting:** Use Windows shells, check paths, verify dataset

**The Windows build is ready to generate high-quality 3D reconstructions!**

For execution, remember:
- ✅ Use Windows Command Prompt or PowerShell
- ❌ Avoid Git Bash/MINGW64 for full SLAM runs
- ✅ All other tools (testing, scripts) work fine in any environment

---

*Document Version: 1.0*
*Last Updated: December 2, 2025*
*Build Status: Fully Functional*
